# 预处理

## 关键点和AUs

### 剪切人脸

安装依赖

```bash
!pip install retina-face
```

```python
from retinaface import RetinaFace
import cv2

# 读取图像
image_path = '/kaggle/input/casme2/rawpic/rawpic/s23/23_0503unnyfarting/img001.jpg'
image = cv2.imread(image_path)

# 使用 RetinaFace 进行人脸检测
faces = RetinaFace.detect_faces(image_path)

# 遍历检测到的人脸
for i, (key, face) in enumerate(faces.items()):
    if 'facial_area' in face:
        # 可能是 [x_min, y_min, x_max, y_max]
        (x_min, y_min, x_max, y_max) = face['facial_area']
        
        # 确保坐标在图像范围内
        x_min = max(x_min, 0)
        y_min = max(y_min, 0)
        x_max = min(x_max, image.shape[1])
        y_max = min(y_max, image.shape[0])
        
        # 调整剪切区域以去掉脖子
        height_reduction = 30  # 根据需要调整
        y_max = min(y_max - height_reduction, image.shape[0])
        
        # 剪切人脸区域
        face_image = image[y_min:y_max, x_min:x_max]
        
        # 保存剪切的人脸
        cv2.imwrite(f'face_{i}.png', face_image)
        
    else:
        print(f'Face {i} does not contain "facial_area" key')
```

## 提取光流特征

### TV-L1光流

#### 使用两张图片提取

安装依赖

```bash
!pip install opencv-python
!pip install opencv-contrib-python
!pip install opencv-contrib-python-headless
```

```python
import cv2
import numpy as np

# 读取两帧图像（假设image1和image2是你的视频帧）
image1 = cv2.imread('/kaggle/input/casme2/rawpic/rawpic/s23/23_0503unnyfarting/img001.jpg', cv2.IMREAD_GRAYSCALE)
image2 = cv2.imread('/kaggle/input/casme2/rawpic/rawpic/s23/23_0503unnyfarting/img002.jpg', cv2.IMREAD_GRAYSCALE)

# 初始化Dual TV-L1光流算法
optical_flow = cv2.optflow.DualTVL1OpticalFlow_create()

# 计算光流
flow = optical_flow.calc(image1, image2, None)

# 将光流的水平和垂直分量分开
flow_x = flow[:, :, 0]
flow_y = flow[:, :, 1]

# 计算光流的幅度和方向
magnitude, angle = cv2.cartToPolar(flow_x, flow_y)

# 映射光流方向到颜色空间（例如HSV）
hsv = np.zeros_like(cv2.cvtColor(image1, cv2.COLOR_GRAY2BGR))
hsv[..., 1] = 255  # 饱和度设置为最大值
hsv[..., 0] = angle * 180 / np.pi / 2  # 方向映射到[0, 180]度
hsv[..., 2] = cv2.normalize(magnitude, None, 0, 255, cv2.NORM_MINMAX)  # 幅度归一化

# 转换回BGR格式
flow_rgb = cv2.cvtColor(hsv, cv2.COLOR_HSV2BGR)

# 显示或保存结果
cv2.imwrite('optical_flow_result.png', flow_rgb)
```

